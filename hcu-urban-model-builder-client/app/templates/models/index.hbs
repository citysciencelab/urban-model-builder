{{page-title (t "routes.models.index.title")}}

<div class="container main-content">
  <div class="card">
    {{! header }}
    {{#let this._q as |searchQuery|}}
      <ModelsIndexHeader
        @onShowSearch={{this.onShowSearch}}
        @hasSearchQuery={{this.hasSearchQuery}}
        @q={{this.q}}
        @searchQuery={{searchQuery}}
        @clearSearch={{this.clearSearch}}
        @onSearchChange={{this.onSearchChange}}
        @sort_key={{this.sort_key}}
        @sort_direction={{this.sort_direction}}
        @onSortChange={{this.onSortChange}}
        @startCreating={{this.startCreating}}
      />
    {{/let}}
    {{! list }}
    <BsListGroup class="list-group-flush" as |ListGroup|>
      {{#let this.persistedModels as |models|}}
        {{#each models as |model|}}
          {{#let
            (if
              model.latestDraftVersion
              model.latestDraftVersion
              model.latestPublishedVersion
            )
            as |currentModelVersion|
          }}
            <ListGroup.item class="list-group-with-actions">
              <div class="list-group-body">
                <div class="list-group-body-content">
                  {{! Model name }}
                  <LinkTo
                    @route="models.versions.show"
                    @models={{array model.id currentModelVersion}}
                  >
                    {{model.internalName}}
                    {{! Published / Draft }}
                  </LinkTo>
                  <span class="meta">
                    {{#if currentModelVersion.publishedAt}}
                      ({{t "models.model.states.published"}})
                    {{else}}
                      ({{t "models.model.states.draft"}})
                    {{/if}}
                  </span>
                </div>
                {{! Meta }}
                <div class="list-group-meta">
                  {{! Meta: Version }}
                  <Model::VersionSelect
                    @model={{model}}
                    @currentVersion={{currentModelVersion}}
                  />
                  {{! Permissions }}
                  <span
                    class="badge rounded-pill badge-success text-bg-secondary text-light"
                  >
                    <FaIcon @icon="shield" @fixedWidth={{false}} />
                    &nbsp;
                    {{#if (eq this.user.currentUserId model.createdBy.id)}}
                      {{t "permissions.creator"}}
                    {{else if model.role}}
                      {{t (concat "permissions." model.role)}}
                    {{else}}
                      {{t "permissions.0"}}
                    {{/if}}
                  </span>

                  {{! Meta: Created at }}
                  <span
                    title={{concat
                      (t "general.created_at")
                      ": "
                      (format-date
                        model.createdAt localeMatcher="lookup" format="dateTime"
                      )
                    }}
                  >
                    <FaIcon
                      @icon="calendar-plus"
                      @fixedWidth={{true}}
                    />{{format-date model.createdAt}}
                  </span>
                  {{! Meta: Updated at }}
                  <span
                    title={{concat
                      (t "general.modified_at")
                      ": "
                      (format-date
                        model.updatedAt localeMatcher="lookup" format="dateTime"
                      )
                    }}
                  >
                    <FaIcon @icon="code-commit" @fixedWidth={{true}} />
                    {{time-ago this.intl.primaryLocale model.updatedAt}}
                  </span>
                  {{! Created By }}
                  <span>
                    <FaIcon @icon="user" @fixedWidth={{true}} />
                    {{model.createdBy.email}}
                  </span>
                </div>
              </div>
              {{! Actions }}
              <div class="list-group-actions">
                <LinkTo
                  @route="models.versions.show"
                  @models={{array model.id currentModelVersion}}
                >
                  <FaIcon @icon="eye" />
                </LinkTo>
                <a
                  href="#"
                  class="{{if model.canEdit '' 'disabled'}}"
                  {{on "click" (fn this.startEditing model)}}
                >
                  <FaIcon @icon="pencil" />
                </a>
                <a
                  href="#"
                  class="{{if model.canDelete '' 'disabled'}}"
                  {{on "click" (fn this.startDeleting model)}}
                >
                  <FaIcon @icon="trash" />
                </a>
              </div>
            </ListGroup.item>
          {{/let}}
        {{else}}
          <ListGroup.item>
            <div class="list-group-body">
              {{t "routes.models.index.no_models_found"}}
            </div>
          </ListGroup.item>
        {{/each}}
      {{/let}}
    </BsListGroup>
    {{! footer }}
    <div class="card-footer model-index-footer text-body-secondary">
      <Ui::Pagination
        @model={{this.persistedModels}}
        @limit={{this.limit}}
        @total={{this.model.meta.total}}
        @page={{this.page}}
        @onPageChanged={{this.onPageChanged}}
        @onLimitChanged={{this.onLimitChanged}}
      />
    </div>
  </div>
</div>

{{! Use the new component for the Modal / Form }}
<Model::FormModal
  @isOpen={{this.isModalOpen}}
  @mode={{this.mode}}
  @changeset={{this.changeset}}
  @onClose={{this.closeModal}}
  @onSubmit={{this.submitModel}}
/>